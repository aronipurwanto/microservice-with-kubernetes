version: '3.8'

services:
  consul:
    image: consul:1.15
    container_name: service-discovery-consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    networks:
      - service-discovery-network

  apigateway:
    build:
      context: .
      dockerfile: src/services/ApiGateway/Dockerfile
    container_name: service-discovery-apigateway
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Consul__Url=http://consul:8500
    depends_on:
      - consul
    networks:
      - service-discovery-network

  orderservice:
    build:
      context: .
      dockerfile: src/services/OrderService/Dockerfile
    container_name: service-discovery-orderservice
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Consul__Url=http://consul:8500
      - Service__Port=80
    depends_on:
      - consul
    networks:
      - service-discovery-network

  userservice:
    build:
      context: .
      dockerfile: src/services/UserService/Dockerfile
    container_name: service-discovery-userservice
    ports:
      - "5003:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Consul__Url=http://consul:8500
      - Service__Port=80
    depends_on:
      - consul
    networks:
      - service-discovery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
  
  inventoryservice:
    build:
      context: .
      dockerfile: src/services/InventoryService/Dockerfile
    container_name: service-discovery-inventoryservice
    ports:
      - "5004:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Consul__Url=http://consul:8500
      - Service__Port=80
    depends_on:
      - consul
    networks:
      - service-discovery-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

networks:
  service-discovery-network:
    driver: bridge